name: Analyse the code quality and check for security issues

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
      
      - uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Analyze code
        id: analyze
        continue-on-error: true
        run: flutter analyze > analyze_report.txt 2>&1 || true 
      
      - name: Vuln scan (Trivy)
        id: trivy
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'table'
          output: 'trivy_report.txt'
      
      - name: Scan secrets (TruffleHog)
        id: secrets
        continue-on-error: true
        run: |
          # Running via docker to easily capture output to a file
          docker run --rm -v "$(pwd):/pwd" trufflesecurity/trufflehog:latest github --repo "file:///pwd" --print --only-verified > secrets_report.txt 2>&1

      - name: Send All Reports to Discord
        if: always()
        run: |
          STATUS="${{ steps.analyze.outcome == 'success' && '✅ PASSED' || '❌ FAILED' }}"
          MSG="**CI Results for ${{ github.event.pull_request.title || 'Branch' }}**\n**Status**: $STATUS\n**Branch**: \`${{ github.head_ref || github.ref_name }}\`\n**Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Send Discord notification with all 3 report files
          curl -H "Content-Type: multipart/form-data" \
               -F "content=$MSG" \
               -F "file1=@analyze_report.txt" \
               -F "file2=@trivy_report.txt" \
               -F "file3=@secrets_report.txt" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Upload analyze report to Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-quality-reports
          path: |
            analyze_report.txt
            trivy_report.txt
            secrets_report.txt


      # This is the "Safety Net" that fails the PR after the Discord message is sent
      - name: Fail if analysis found issues
        run: |
          if ! grep -q "No issues found" analyze_report.txt; then
            echo "Failing build because flutter analyze found issues."
            exit 1
          fi
