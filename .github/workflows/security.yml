name: Analyse the code quality and check for security issues

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
      
      - uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Analyze code
        id: analyze
        continue-on-error: true
        run: flutter analyze > analyze_report.txt
      
      - name: Upload analyze report to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-analyze-report
          path: analyze_report.txt
      
      - name: Send Report to Discord
        if: always()
        run: |
          STATUS="${{ steps.analyze.outcome == 'success' && 'PASSED' || ' FAILED' }}"
          MSG="**Flutter Analysis Results**\n**Status**: $STATUS\n**Branch**: \`${{ github.head_ref || github.ref_name }}\`\n**Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Send the text message and the file together
          curl -H "Content-Type: multipart/form-data" \
               -F "content=$MSG" \
               -F "file=@analyze_report.txt" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Security audit deps
        run: flutter pub outdated
      
      - name: Scan secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
      
      - name: Vuln scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy-results.sarif'
          scan-ref: '.'
      
      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check final status
        if: steps.analyze.outcome != 'success'
        run: |
          echo "Analysis failed. Check the attached report in Discord or GitHub Artifacts."
          exit 1
